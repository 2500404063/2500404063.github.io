# AXI总线事务结构
事务结构将会介绍：
1. 地址结构
2. 一个传输过程的伪代码（本文省略，读者可以参考原文档）
3. 读和写的结构
4. 读响应和写响应的结构
5. 主机和从机的缓冲区

## 地址结构
如果读者在阅读之前的文章，理解了ARLEN和ARSIZE的区别，和Transaction和Transfer的区别的话，这里不用看也懂了。
AXI协议是基于Burst机制的。
主机发送一个Burst是通过，把控制信息和地址给从机，从机通过计算出正确的地址来进行读写。
但是读写不能超过4KB的地址空间。

**Burst Size(AxSIZE)：**
其实这个BurstSize的长度是可以自定义的，但不宜过长。
假设AxSIZE[2:0]
0b000：1个字节
0b001：2个字节
0b010：4个字节
0b011：8个字节
0b100：16个字节
0b101：32个字节
0b110：64个字节
0b111：128个字节
**注意：这个AxSIZE的意思不是指主机要发送这么多数据，而是从机要改写这么多数据。**
因为地址总线是32位的，所以主机一次事务最多可以发送4字节，因为一旦握手成功之后，主机就没有机会更改WDATA的内容了。

**Burst Type(AxBURST)：**
Burst的类型有3种：
1. FIXED：也就是每次Transfer的地址都是一样的。（AXI总线一旦把读写请求(也就是控制信息)发出去后，就没有机会再次修改了，所以WSTRB也会是一样的）这种一般用在FIFO进行复写的时候。
2. INCR：每一次的Transfer会递增地址，地址递增的大小由BurstSize决定(AxSize)，比如对于对齐的地址，BurstSize是4字节，那么每次就会在原地址+4作为下一次的地址。
3. WRAP：这个的意思是复写的意思，和INCR有一点像。它的特点是，当地址递增到溢出边界地址的时候，就会回到起始地址。边界地址是Address+BurstSize*TransferLength。

## 读和写结构
### Write Strobe
这个之前已经介绍过了，为了让大家对各种通道的各种信号的概念都了解。
这里再写一次。
写通道里面有一个WSTRB(Write Strobe)，就是**写选通**
写选通的作用是，标记数据总线上那些数据是有效的。
我们举个例子。
首先，写选通是二进制向量，也就是说一个位控制一个选通。
假设数据总线是32位的，也就是data[31:0]，AXI总线最小传输单位是字节。
也就是说，data可以被分成四份，那么WSTRB也就有四个位，每个位控制数据总线上的每个部分。
这里要注意大小端，这里我们选择小端模式。
WSTRB=0011，就表示data[15:0]的数据是有效的，所以从机在读取的时候应该读取data[15:0]

### 狭窄传输(Narrow Transfer)
指的是传输的字节长度小于数据总线的字节长度，其实上面也已经说明了，只是这里再次强调一下。
在狭窄传输的时候，Burst类型会产生以下效果:
1. 对于INCR和WRAP模式：会使用**不同**的字节选通。所以每次Transfer也要对WSTRB进行左移。
2. 对于FIXED模式，会使用**相同**的字节选通。

举个例子，假设：
1. 地址总线32位
2. 狭窄传输1字节
3. Burst模式是WRAP模式
4. 开始地址是0
5. 一共3次传输

那么，传输过程就会是：
![narrow_transfer](./pages_hardware/axi/res/narrow_transfer.png)

> 这里需要提醒一下，要注意大小端模式

## 读和写响应结构
读和写都有响应通道：RRESP（读响应），BRESP（写响应）
响应类型：
1. OKAY(0b00)：正常访问成功，也可以表明独占访问失败。
2. EXOKAY(0b01)：独占访问成功
3. SLVERR(0b10)：从机错误，表示虽然主机的请求成功到达了从机，但是从机处理不好，失败了。
4. DECERR(0b11)：解码错误，表示这个地址上没有从机可以处理，通常是被总线上的一个组件发起。

### OKAY
以下情况发送OKAY响应：
1. 正常访问成功
2. 独占访问失败
3. 目标从机不支持独占模式
在AXI总线当中，绝大部分都是OKAY
### EXOKAY
1. 独占访问失败

### SLVERR
1. 超出FIFO或者Buffer的大小
2. 不支持的BurstSize
3. 尝试写从机的ReadOnly区域
4. 超时操作

### DECERR
解码错误，表示这个地址上没有从机可以处理，通常是被总线上的一个组件发起。
所以在设计实现AXI总线的时候，可以设置一个默认的从机，只负责用来判断地址是否有效。

## 主机和从机的缓冲区
AXI总线只有一条(5个通道)，但是上面挂了很多组件(接口)，
为了保证传输效率，主机不能一直保持数据总线数据，地址总线数据，控制数据。
一旦主机和从机握手成功后，从机就应该把主机的数据总线，地址总线，控制数据上的信息都缓存起来，然后从机开始处理。
一旦从机拿到主机的相关数据之后，主机就要去和其他的从机进行握手，进行下一次的事务。
所以主机和从机都需要具有相应的缓冲区来保存数据。

## 参考文献
本文由官方文档翻译而来，笔者翻译水平有限，望谅解。
[1] AMBA_AXI_protocol_spec——ARM