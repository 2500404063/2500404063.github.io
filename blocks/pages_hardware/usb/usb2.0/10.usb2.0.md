# USB2.0简介
USB是一种总线
设计者：Compaq, DEC, IBM, Intel, Microsoft, NEC and Nortel
设计时间：1994
制造商：Intel, Compaq, Microsoft, NEC, Digital Equipment Corporation, IBM, Nortel
前身：串行接口, 并行接口, 游戏端口, Apple Desktop Bus, PS/2接口

## 规格
1. USB 2.0引脚	4个（1个供电，2个数据，1个接地）；
1. USB 3.0拥有 9个（另外4个提供给SuperSpeed技术）；
1. USB 3.1 Type-C拥有24个

## USB电力供应
1. 信号	5伏特直流电
1. 最大电压	20 V（±5%)（根据不同版本）
1. 最大电流	500mA–5A @ 5V（根据不同版本）

## USB数据
1. 数据信号：由规范定义的数据包
1. 宽度：1 bit
1. 比特率：1.5/12/480/5,000/10,000/20,000/40,000 Mbit/s（根据不同版本）
1. 最多设备数：127
1. 协议：串列

## USB引脚输出
USB引脚输出
标准USB A型连接器（左）及B型连接器（右）
![](./pages_hardware/usb/res/usba_pin.png)
引脚1	VCC（+5V）
引脚2	Data-
引脚3	Data+
引脚4	接地

## USB速度识别
**没有设备**连接到主机时：D+和D-数据线上的下拉电阻（在集线器内部）起作用，使得两者都在低电平;主机端看来就是个SE0状态，同样地，当数据线上的SE0状态持续一断时间后，就被主机认为是断开状态。

设备连接到主机时：当主机检到某一个数据线电平拉高并保持了一段时间，就认为有设备连上来了。 主机必需在驱动SE0状态以复位设备之前， 立刻采样总线状态来判断设备的速度

低速设备和全速，高速设备的接线区别如下：
![use_speed](./pages_hardware/usb/res/usb_speed.png)
低速设备：对D-进行上拉，D+不做处理，因为内部D+和D-都有下拉电阻。
全速/高速设备：对D+进行上拉，D-不做处理，因为内部D+和D-都有下拉电阻。
一般上拉所接的电压是3.3V，5V应该也行。只要超过判断的阈值电压即可。

## USB设备的断开
USB设备从USB总线断开时，包括以下几个步骤：

对于硬件层：就是直接拔掉，D+和D-会变成低电平，并持续一段时间表示断开。
对于软件层：需要经历以下过程
1. USB设备从集线器下行端口断开时，集线器禁止该端口，并通过中断IN通道向USB主机报告其端口变化。
2. 主机收到端口变化后发送GetPortStatus获取详细信息，并做处理断开操作。
3. 系统调用USB驱动程序的断开回调函数，释放该设备占用的所有系统资源。
> 如果断开的是一个USB集线器，USB主机会对该集线器和其所连接的所有设备进行断开操作。

## USB 的优点有以下几点：
1. USB为所有的USB外设提供了单一的、易于使用的标准的连接类型，这样一来就简化了USB外设的设。同时也简化了用户在判断哪个插头对应哪个插槽时的任务,实现了单一的数据通用接口.
1. 整个的USB的系统只有一个端口和一个中断 节省了系统资源。
1. USB支持热插拔(hot plug)和 PNP(Plug-and-Play)， 也就是说在不关闭PC的情况下可以安全的插上和断开USB设备。 计算机系统动态地检测外设的插拔，并且动态地加载驱动程序，其他普通的外围连接标准如SCSI设备等必须在关掉主机的情况下才能插拔外围设备。
1. USB在设备供电方面提供了灵活性。 USB直接连接到Hub或者是连接到Host的设备可以通过USB电缆供电，也可以通过电池或者其它的电力设备来供电或使用两种供电方式的组合.并且支持节约能源的挂机和唤醒模式.
1. USB提供全速12Mbps的速率和低速 1.5Mbps的速率来适应各种不同类型的外设USB2.0 还支持480Mbps的高速传输速率(USB3.0超高带也实现了对USB2.0及以下版本的兼容支持).
1. 为了适应各种不同类型外围设备的要求，USB提供了四种不同的数据传输类型。控制传输、批量传输、中断传输和同步传输。 同步数据传输可为音频和视频等实时设备的实时数据传输提供固定带宽.
1. USB的端口具有很灵活的扩展性， 一个 USB端口串接上一个USBHub就可以扩展为多个USB端口。
1. 携带方便。USB设备大多以“小、轻、薄”见长，对用户来说，随身携带大量数据时，很方便。当然USB硬盘是首要之选了。
1. 标准统一。大家常见的是IDE接口的硬盘，串口的鼠标键盘，并口的打印机扫描仪，可是有了USB之后，这些应用外设统统可以用同样的标准与个人电脑连接，这时就有了USB硬盘、USB鼠标、USB打印机等等。
1. 可以连接多个设备。USB在个人电脑上往往具有多个接口，可以同时连接几个设备，如果接上一个有四个端口的USB HUB时，就可以再连上;四个USB设备，以此类推，尽可以连下去，将你家的设备都同时连在一台个人电脑上而不会有任何问题(注：最高可连接至127个设备)。

## 数据编码
### RZ编码
RZ 编码（Return-to-zero Code），也叫归零编码。
在该编码试工中，正电平代表逻辑1，负电平代码逻辑0，并且每次传输完一位数据，信号都会回到零电平。这样，在信号线上会产生3种电平：正电平、负电平、零电平，相应的信号图例如下：
![](./pages_hardware/usb/res/rz.png)
从上图中可看出，每们数据传输中都有一个归零的过程，这样接收端只需要在归零后进行新的采样，这样就不需要单独的时钟信号，这实际上相当于把时钟信号用归零处理在传输的数据中，这种信号叫自同步（self-clocking）信号。  
这虽然节省了信号线，不过还是有它固有的缺点，由于RZ编码信号中有大部分数据带宽被用于传输“归零”信号而浪费掉了。除了省去这个步骤，NRZ编码就产生了，相对于RZ编码，NRZ编码就是不需要“归零”。
### NRZ 编码（Non-return-to-zero Code），也叫不归零编码。
下图是NRZ编码的信号图例：
![](./pages_hardware/usb/res/nrz.png)
从上图可以看到，每一位信号都不需要“归零”了，被浪费的带宽收回了，但又失去了应有的自同步特性，让我们感觉又回到了起点，那么先继续了解NRZI编码吧。

### NRZI 编码（Non-Return-to-Zero Inverted Code），也叫反向不归零编码。
NRZI编码与NRZ编码的区别就是NRZI用翻转来表示一个逻辑，而信号保持不变来表示另一个逻辑。而在USB传输的编码中采用的是NRZI格式，电平翻转代表逻辑0，电平不变代表1。
![](./pages_hardware/usb/res/nrzi.png)
从上面的了解，NRZ和NRZI都失去了自同步特性，不过还是可以通过一些技巧来处理。
在USB中，每个数据包的最开始处都有一个同步域（SYNC），其值为00000001，在经过NRZI编码后，就是一串方波，接收方可能过这个同步头来计算发送方的频率，以便用这个频率来继续采样数据信号。由于USB所采用的NRZI编码中，每当逻辑0时就会进行电平翻转，那么接收方可通过这个不断翻转的信号来调整同步的频率，保证数据的正确传输。

但这仍然存在问题，一旦电平长时间保持不变时，我们无法知道,到底是发送的是100个逻辑1，还是1000个逻辑1，即使传输的是100个逻辑1，但接收方与发送方的频率相差了100分之1，那么也还是存在可能把数据采集成为99或者101。而USB中采用了Bit-Stuffing位填充处理，即在连续发送6个1后面会插入1个0，强制使发送信号进行翻转，从而让接收方调整频率，同步接收。而接收方在接收时只要接收到连续的6个1后，直接将后面的0删除即可恢复数据的原貌。

接收方只需要将上面接受到的NRZI编码数据进行译码，再进行位反填充即可还原为原始数据了。此种编码方式除了在USB上使用，还有在CD光盘以及使用光纤传输的100BASE-FX（Fast Ethernet）等产品、领域。 