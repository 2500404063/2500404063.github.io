# Mean Filter
本节我们来讲均值滤波，在这个例子中，我们将估计黄金的重量。
均值测量没有系统误差，但均值测量有随机噪声。
如下图所示的数据结果
![ex1_MeasurementsVsTrueVal](./pages_hardware/robot/res/ex1_MeasurementsVsTrueVal.png)

## 递推推导

一个直观的想法，就是求它们的均值：
$\hat{x}_{n,n}$在已知$z_n$之后在n时刻估计的值。
$\hat{x}_{n,n}= \frac{1}{n} \left( z_{1}+ z_{2}+ \ldots + z_{n-1}+ z_{n} \right) = \frac{1}{n} \sum _{i=1}^{n} \left( z_{i} \right)$

确实是这样做的，但是如果按上述这种求法，当数据量非常大的时候，我们需要一个非常强大的CPU和容量较大的RAM，让我们来做一些数学小技巧。

这是上面的那个最原始的求均值的公式
$\hat{x}_{n,n}= \frac{1}{n} \sum _{i=1}^{n} \left( z_{i} \right)$

让我们从求和列表当中提取一个出来
$=\frac{1}{n} \left(  \sum _{i=1}^{n-1} \left( z_{i} \right)  + z_{n} \right)$

把系数乘进去，把括号去掉
$= \frac{1}{n} \sum _{i=1}^{n-1} \left( z_{i} \right) + \frac{1}{n} z_{n}$

为了让n-1的均值形式恢复，我们乘一个(n-1)/(n-1)
$= \frac{1}{n}\frac{n-1}{n-1} \sum _{i=1}^{n-1} \left( z_{i} \right) + \frac{1}{n} z_{n}$

然后其中一部分就变成n-1的均值形式了，我们就找到了n-1和n的递推关系
$=\frac{n-1}{n}{\frac{1}{n-1} \sum _{i=1}^{n-1} \left( z_{i} \right)} + \frac{1}{n} z_{n}$

换一种形式来写，$\hat{x}_{n-1,n-1}$表示n-1次的均值
$= \frac{n-1}{n}{\hat{x}_{n-1,n-1}} + \frac{1}{n} z_{n}$

然后把$\frac{n-1}{n}$分离常量，得到如下
$= \hat{x}_{n-1,n-1}-\frac{1}{n}\hat{x}_{n-1,n-1}+ \frac{1}{n} z_{n}$

然后交换一下加减顺序，提取公因式
$= \hat{x}_{n-1,n-1}+\frac{1}{n} \left( z_{n}-\hat{x}_{n-1,n-1} \right)$

## 引入预测

然后现在我们来重新定义一下，加上预测的功能
$\hat{x}_{n,n-1}$表示根据n-1的估计值来预测n时刻的预测值
在这个例子当中，$\hat{x}_{n,n-1}$ = $\hat{x}_{n-1,n-1}$，也就是上一次的估计值就是下一次的预测值。

所以上面的表达式可以写为
$\hat{x}_{n,n}=\hat{x}_{n,n-1}+ \frac{1}{n} \left( z_{n}-\hat{x}_{n,n-1} \right)$
这么改写的目的，是为了引入“从上一时刻真实值来预测当前时刻的预测值”这样的一个过程。
上面的1/n是一个平均值，为了让它可以适应更多的情况，采用加权平均，1/n就变成了一个系数α。
$\hat{x}_{n,n}= \hat{x}_{n,n-1}+  \alpha _{n} \left( z_{n}-\hat{x}_{n,n-1} \right)$
用文字来表达就是
当前时刻估计值=当前时刻的预测值 + 系数(测量值-当前时刻的预测值)

## 代值举例
### 第零次迭代
假设这个金条的真实质量是1010。
$\hat{x}_{0,0}$可以是非常粗鲁的估计，作为第0次的值。
这里我们假设$\hat{x}_{0,0}=1000$，所用单位为克。
预测下一次的值：$\hat{x}_{1,0} = \hat{x}_{0,0}=1000$，因为我们已知黄金的质量肯定不会发生变化，所以这个预测方程就是静态的常数。

### 第一次迭代
测量值：$z_1 = 1030$
增益系数：$\alpha_1 = \frac{1}{1}$
第一次的估计值：$\hat{x}_{1,1} = \hat{x}_{1,0} + \alpha_1(z_1-\hat{x}_{1,0}) = 1000+1(1030-1000)=1030$
预测下一次：$\hat{x}_{2,1} = \hat{x}_{1,1}=1030$

### 第二次迭代
测量值：$z_2 = 989$
增益系数：$\alpha_2 = \frac{1}{2}$
第二次的估计值：$\hat{x}_{2,2} = \hat{x}_{2,1} + \alpha_2(z_2-\hat{x}_{2,1}) = 1030 + 0.5(989-1030)=1009.5$
预测下一次：$\hat{x}_{3,2} = \hat{x}_{2,2}=1009.5$

### 第n次迭代
$\hat{x}_{3,3} = 1012$
$\hat{x}_{4,4} = 1011.25$
$\hat{x}_{5,5} = 1011.6$
$\hat{x}_{6,6} = 1006.17$
$\hat{x}_{7,7} = 1006.43$
$\hat{x}_{8,8} = 1010.87$
$\hat{x}_{9,9} = 1011$
$\hat{x}_{10,10} = 1011$

![ex1_MeasVsTrueVsEst.png](./pages_hardware/robot/res/ex1_MeasVsTrueVsEst.png)