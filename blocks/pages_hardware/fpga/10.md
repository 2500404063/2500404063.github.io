# FPAG原理介绍

## 内部结构
FPGA的内部结构主要包含六大部分，分别是：可编程的输入输出IO口、可编程的逻辑单元、底层嵌入式功能单元、嵌入式块RAM、布线资源和硬核。以下是具体的介绍。
如图所示：
![fpga1](./pages_hardware/fpga/res/fpga1.png)

实际开发中可以从这四个方面认识FPGA的内部结构，分别是：
1. 布线资源(IR)：Interconnect Resource
2. 可配置逻辑单元（CLU)：Configurable Logic Unit
3. 输入输出块（IOB）：Input Output Block
4. 可编程开关（PSW）：Programmable Switch

CLB：可配置逻辑功能块CLB是FPGA的基本逻辑单元，为用户提供逻辑功能，遍布整个芯片。
IOB：可配置芯片引脚，有多种模式，可以配置开关类型（TTL,MOS），电平类型，上拉下拉等。
IR：包括各种长度的连线线段，和可编程开关连接(PSW)，连接到各个CLB，IOB，通过开关实现连线。

## 布线通道
### 布线控制原理
![wires](./pages_hardware/fpga/res/wires.webp)
上图是CPLD的结构图，其中有很多线，FPGA也类似。通过设置这些门的连线，就可以组合成一些逻辑表达式。
其中，实心的是固定的，不能改变的；打叉的部分是可编程连接，通过SRAM来控制。

这些交叉点的通断控制有很多实现方式，起初用紫外线或激光对交叉点进行照射使其熔断或熔接。
现在可以用存储器的值去控制三极管通断实现交叉点通断。
所以，对可编程逻辑器件下载配置，实际上可以理解为给存储器赋值。

这里就需要说一下SRAM，在FPGA里面这个更应该是ROM，当上电后，FPGA读取储存器里面的值，然后就把`初始连线方式`连好了。下面讲LUT的时候会更能体现这一点。
### 布线类型
布线资源连通FPGA内部的所有单元，而连线的长度和工艺决定着信号在连线上的驱动能力和传输速度。
FPGA芯片内部有着丰富的布线资源，根据工艺、长度、宽度和分布位置的不同而划分为４类不同的类别。

第一类是全局布线资源，用于芯片内部全局时钟和全局复位/置位的布线；
第二类是长线资源，用以完成芯片Bank间的高速信号和第二全局时钟信号的布线；
第三类是短线资源，用于完成基本逻辑单元之间的逻辑互连和布线；
第四类是分布式的布线资源，用于专有时钟、复位等控制信号线。

![wire1](./pages_hardware/fpga/res/wire1.png)
![wire2](./pages_hardware/fpga/res/wire2.png)
![wire3](./pages_hardware/fpga/res/wire3.png)

在实际中设计者不需要直接选择布线资源，布局布线器可自动地根据输入逻辑网表的拓扑结构和约束条件选择布线资源来连通各个模块单元。
从本质上讲，布线资源的使用方法和设计的结果有密切、直接的关系。

## 可编程逻辑单元(CLU)
可配置逻辑单元支持基本查找表、算术逻辑和存储器模式：
**基本查找表模式**
每个查找表可以被配置为一个 4 输入查找表(LUT4)，可配置逻辑单元可
实现高阶查找表功能：
- 一个可配置功能片可配置成一个 5 输入查找表(LUT5)。
- 两个可配置功能片可配置成一个 6 输入查找表(LUT6)。
- 四个可配置功能片可配置成一个 7 输入查找表(LUT7)。
- 八个可配置功能片(两个 CLU)可配置成成一个 8 输入查找表(LUT8)。
**算术逻辑模式**
结合进位链，查找表可配置成算术逻辑模式(ALU)，用作实现以下功能：
- 加法/减法运算
- 计数器，包括加计数器和减计数器
- 比较器，包括大于比较、小于比较和不相等比较
- 乘法器
**存储器模式**
在此模式下，可用可配置逻辑单元构成分布式静态随机存储器（SSRAM）或只读存储器。

## 详解LUT
LUT实现的功能与真值表类似，但是不是真值表。
### 先看传统的真值表
定义：
```txt
//定义：
input a
input b
output c
output d
assign c = a & b
assign d = a | b
//真值表：
a   b   c   d
0   0   0   0
0   1   0   1
1   0   0   1
1   1   1   1
```
但是这种方式，缺点很明显，我们在设计电路的时候需要经历以下步骤：
1. 画出真值表
2. 根据真值表得到逻辑表达式
3. 通过卡诺图化简逻辑表达式
4. 用逻辑电路实现逻辑表达式

众所周知，在设计时序电路时，时序电路的工作性能极为重要。
然而，采用传统逻辑门电路实现逻辑关系的方法存在一些严重的缺点：
1. 输入变量从通过逻辑电路到输出变量，存在一定的延迟，该延迟的大小和逻辑电路的复杂程度密切相关。逻辑电路越复杂，延迟越大，因此，**延迟是不确定的**；
2. 延时的倒数是频率，频率和时序电路的工作速率密切相关。因为延迟不确定，所以**频率也不确定**，这将严重影响整个电路的工作性能；
3. 逻辑电路的复杂程度和输入逻辑变量的个数、逻辑门的个数有关。因此**输入逻辑变量越多，逻辑电路就越复杂**。

### LUT
FPGA内部可编程单元结构采用"查找表结构"（LUT，look up table）如下图，左侧一列是16X1bit的位存储单元SRAM，储存的是**真值表的输入和输出的运算后的结果**，从这里可以看出，其作用相当于是ROM，但是采用的是SRAM（掉电丢失）为什么呢？见后文。
输入信号是ABCD，输出信号F在图的最右侧。
ABCD相当于这个**存储器的地址线**，选择16位存储器中的一个值输出。
通过修改存储单元RAM的内容，这个电路结构就可实现任意的F（A，B，C，D）逻辑函数。
这个结构和数字电路中真值表的功能是一模一样的。
根据输入地址，输出不同值，所以叫查找表结构。
LUT-4，表示4个输入，对应1个bit输出，SRAM是2^4*1
LUT-6，表示6个输入，对应1个bit输出，SRAM是2^6*1
![lut](./pages_hardware/fpga/res/lut.webp)

**优点：**
1. 通过LUT代替组合逻辑，而**LUT中的值只和输入有关**，因此组合逻辑的功能由输入决定，不在和复杂度有关
2. LUT实现的组合逻辑的**延迟是固定的**

> 为什么选择SRAM？
> 一旦SRAM单元被载入数据后，他将保持不放电，但如果整个供电系统断了的话，器件配置的数据将会丢失，这就是说这种器件在系统上电时需要重新配置。但是这种器件的特点是可迅速反复的编程，这就是当时选中SRAM技术实现FPGA的很大原因。但是代码是储存在FPGA的ROM里面的，上电后进行对SRAM(LUT)进行配置。

#### LUT-6是由2个LUT-5组成
![lut6](./pages_hardware/fpga/res/lut6.png)
如上图所示，有两个LUT-5，一个数据选择器(MUX)。
上面的LUT-5储存的是，当I5=0的值，
下面的LUT-5储存的是，当I5=1的值，
然后再经过一个数据选择器(MUX)，这样就可以得到结果了！

#### LUT多输出
如果我们想5输入，2输出怎么办？
其实就是用一个LUT-6，然后去掉数据选择器(MUX)即可。

#### LUT带来的竞争与冒险
通过上面的原理，我们知道了多输入，多输出的LUT是如何实现的，
根据原理图可见，因为输入比较多的时候，很难确保所有的输入都在同一时刻跳变为正确的值，可能会有先后。
所以，就会导致输出的结果与预期不符。
所以我们往往使用寄存器(触发器)，让所有的输入值都稳定下来，然后再将结果输出，中间的结果并不参考，以确保输出的正确性。
时序问题是FPGA程序设计的比较头疼的问题，还有很多需要注意的地方。

## 可编程输入输出单元（IOB）

可编程输入/输出单元简称I/O单元，是芯片与外界电路的接口部分，完成不同电气特性下对输入/输出信号的驱动与匹配要求，其示意结构如图1-2所示。
FPGA内的I/O按组分类，每组都能够独立地支持不同的I/O标准。
**通过软件的灵活配置，可适配不同的电气标准与I/O物理特性，可以调整驱动电流的大小，可以改变上、下拉电阻。**
目前，I/O口的频率也越来越高，一些高端的FPGA通过DDR寄存器技术可以支持高达2Gbps的数据速率。

IO口有很多模式，具体参考自己芯片的芯片手册。

## 嵌入式块RAM
大多数FPGA都具有内嵌的块RAM，块RAM可被配置为单端口RAM、双端口RAM、内容地址存储器（CAM）以及FIFO等常用存储结构。
说白了，就是内嵌了一块RAM可配置的RAM，FPGA的特点就是这样，很多东西都有，都是可以自行配置的。
除了块RAM，还可以将FPGA中的LUT灵活地配置成RAM、ROM和FIFO等结构。
在实际应用中，芯片内部块RAM的数量也是选择芯片的一个重要因素。

> CAM存储器在其内部的每个存储单元中都有一个比较逻辑，写入CAM中的数据会和内部的每一个数据进行比较，并返回与端口数据相同的所有数据的地址，因而在路由的地址交换器中有广泛的应用。

## 底层内嵌功能单元

内嵌功能模块主要指DLL（Delay Locked Loop）、PLL（Phase Locked Loop）、DSP和CPU等软处理核（Soft Core）。
现在越来越丰富的内嵌功能单元，使得单片FPGA成为了系统级的设计工具，使其具备了**软硬件联合设计的能力**，逐步向SOC平台过渡。

DLL和PLL具有类似的功能，可以完成时钟高精度、低抖动的倍频和分频，以及占空比调整和移相等功能。
Xilinx公司生产的芯片上集成了DLL，Altera公司的芯片集成了PLL，Lattice公司的新型芯片上同时集成了PLL和DLL。
PLL和DLL可以通过IP核生成的工具方便地进行管理和配置。

## 软核、硬核以及固核的概念
IP（Intelligent Property）核是具有知识产权核的集成电路芯核总称，是经过反复验证过的、具有特定功能的宏模块，**与芯片制造工艺无关，可以移植到不同的半导体工艺中**。
到了SOC阶段，IP核设计已成为ASIC电路设计公司和FPGA提供商的重要任务，也是其实力体现。
对于FPGA开发软件，其提供的IP核越丰富，用户的设计就越方便，其市场占用率就越高。
目前，IP核已经变成系统设计的基本单元，并作为独立设计成果被交换、转让和销售。

从IP核的提供方式上，通常将其分为软核、硬核和固核这3类。
从完成IP核所花费的成本来讲，硬核代价最大；从使用灵活性来讲，软核的可复用使用性最高。

1.软核：就是指硬件描述代码
软核在EDA设计领域指的是综合之前的寄存器传输级（RTL）模型；具体在FPGA设计中指的是对电路的硬件语言描述，包括逻辑描述、网表和帮助文档等。软核只经过功能仿真，需要经过综合以及布局布线才能使用。其优点是灵活性高、可移植性强，允许用户自配置；缺点是对模块的预测性较低，在后续设计中存在发生错误的可能性，有一定的设计风险。软核是IP核应用最广泛的形式。

2.固核：直接就是门级网表
固核在EDA设计领域指的是带有平面规划信息的网表；具体在FPGA设计中可以看做带有布局规划的软核，通常以RTL代码和对应具体工艺网表的混合形式提供。将RTL描述结合具体标准单元库进行综合优化设计，形成门级网表，再通过布局布线工具即可使用。和软核相比，固核的设计灵活性稍差，但在可靠性上有较大提高。目前，固核也是IP核的主流形式之一。

3.硬核：固定在FPGA里面的硬件资源，不允许修改的
硬核在EDA设计领域指经过验证的设计版图；具体在FPGA设计中指布局和工艺固定、经过前端和后端验证的设计，设计人员不能对其修改。不能修改的原因有两个：首先是系统设计对各个模块的时序要求很严格，不允许打乱已有的物理版图；其次是保护知识产权的要求，不允许设计人员对其有任何改动。IP硬核的不许修改特点使其复用有一定的困难，因此只能用于某些特定应用，使用范围较窄。


## GowinFPGA概念
可配置功能单元(CFU)和可配置逻辑单元(CLU)是构成高云半导体FPGA产品内核的两种基本单元。

每个基本单元(CFU，CLU)可由四个可配置逻辑块(CLS)以及相应的可配置布线单元(CRU)组成，其中三个可配置逻辑块各包含两个四输入查找表(LUT)和两个寄存器(REG)，另外一个可配置逻辑块只包含两个四输入查找表。

CLU 中的可配置逻辑块不能配置为静态随机存储器，可配置为基本查找表、算术逻辑单元和只读存储器。

CFU 中的可配置逻辑块可根据应用场景配置成基本查找表、算术逻辑单元、静态随机存储器和只读存储器四种工作模式。
如图：
![CFU](./pages_hardware/fpga/res/CFU.png)